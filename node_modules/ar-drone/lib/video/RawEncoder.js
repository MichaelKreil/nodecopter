// Converts a video stream into a stream of raw buffers. Each 'data' event
// is guaranteed to contain exactly 1 raw image.

// @TODO Figure out why ffmpeg.stdin.write seems to always return false and
// never emits 'drain' event (so we can get backpressure working)
// @TODO handle ffmpeg exit (and trigger "error" if unexpected)

var Stream      = require('stream').Stream;
var util        = require('util');
var spawn       = require('child_process').spawn;
var rawSplitter = require('./RawSplitter');

module.exports = RawEncoder;
util.inherits(RawEncoder, Stream);
function RawEncoder(options) {
  Stream.call(this);

  options = options || {};

  this.writable = true;
  this.readable = true;

  this._spawn       = options.spawn || spawn;
  this._frameRate   = options.frameRate || 5;
  this._rawSplitter = options.rawSplitter || new rawSplitter();
  this._log         = options.log;
  this._ffmpeg      = undefined;
  this._ending      = false;
}

RawEncoder.prototype.write = function(buffer) {
  if (!this._ffmpeg) {
    this._initFfmpegAndPipes();
  }

  this._ffmpeg.stdin.write(buffer);
};

RawEncoder.prototype._initFfmpegAndPipes = function() {
  this._ffmpeg = this._spawnFfmpeg();

  // @TODO: Make this more sophisticated for somehow and figure out how it
  // will work with the planned new data recording system.
  if (this._log) {
    this._ffmpeg.stderr.pipe(this._log);
  }

  this._ffmpeg.stdout.pipe(this._rawSplitter);
  this._rawSplitter.on('data', this.emit.bind(this, 'data'));

  // 'error' can be EPIPE if ffmpeg does not exist. We handle this with the
  // 'exit' event below.
  this._ffmpeg.stdin.on('error', function() {});

  var self = this;
  this._ffmpeg.on('exit', function(code) {
    if (code === 0) {
      // we expected ffmpeg to exit
      if (self._ending) {
        self.emit('end');
        return;
      }

      self.emit('error', new Error('Unexpected ffmpeg exit with code 0.'));
      return;
    }

    // 127 is used by the OS to indicate that ffmpeg was not found
    if (code === 127) {
      self.emit('error', new Error('Ffmpeg was not found / exit code 127.'));
      return;
    }

    self.emit('error', new Error('Ffmpeg exited with error code: ' + code));
  });
};

RawEncoder.prototype._spawnFfmpeg = function() {
  // @TODO allow people to configure the ffmpeg path
  return this._spawn('ffmpeg', [
    '-i' ,'-',
    '-f', 'image2pipe',
    '-vcodec', 'rawvideo',
    '-pix_fmt', 'rgb24',
    '-r', this._frameRate,
    '-',
  ]);
};

RawEncoder.prototype.end = function() {
  // No data handled yet? Nothing to do for ending.
  if (!this._ffmpeg) {
    return;
  }

  this._ending = true;
  this._ffmpeg.stdin.end();
};
