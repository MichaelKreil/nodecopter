RawStream.TcpVideoStream = require('./TcpVideoStream');
RawStream.RawEncoder = require('./RawEncoder');

var Stream     = require('stream').Stream;
var util       = require('util');

module.exports = RawStream;
util.inherits(RawStream, Stream);
function RawStream(options) {
  Stream.call(this);

  options = options || {};

  this.readable        = true;
  this._options        = options;
  this._tcpVideoStream = null;
  this._rawEncoder     = null;
}

RawStream.prototype.resume = function() {
  this._resume();
};

RawStream.prototype._resume = function() {
  var self = this;

  this._tcpVideoStream = new RawStream.TcpVideoStream(this._options);
  this._rawEncoder     = new RawStream.RawEncoder(this._options);

  this._tcpVideoStream.on('error', function(err) {
    self._rawEncoder.end();
    self._resume();

    if (self.listeners('error').length > 0) {
      self.emit('error', err);
    }
  });

  this._tcpVideoStream.connect();
  this._tcpVideoStream.pipe(this._rawEncoder);
  this._rawEncoder.on('data', this.emit.bind(this, 'data'));
};
